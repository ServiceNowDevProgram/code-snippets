<?xml version="1.0" encoding="UTF-8"?><unload unload_date="2021-10-04 16:57:17">
<sys_remote_update_set action="INSERT_OR_UPDATE">
<application display_value="GRC: Policy and Compliance Management">4a3281d053030200d23c9c25911c086f</application>
<application_name>GRC: Policy and Compliance Management</application_name>
<application_scope>sn_compliance</application_scope>
<application_version>12.0.4</application_version>
<collisions/>
<commit_date/>
<deleted/>
<description/>
<inserted/>
<name>ExportKBtoPDF-PDFHelper</name>
<origin_sys_id/>
<parent display_value=""/>
<release_date/>
<remote_base_update_set display_value=""/>
<remote_parent_id/>
<remote_sys_id>974209f02f8f78101d84d2172799b680</remote_sys_id>
<state>loaded</state>
<summary/>
<sys_class_name>sys_remote_update_set</sys_class_name>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2021-10-04 16:57:17</sys_created_on>
<sys_id>5957ddf42f43b8101d84d2172799b614</sys_id>
<sys_mod_count>0</sys_mod_count>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2021-10-04 16:57:17</sys_updated_on>
<update_set display_value=""/>
<update_source display_value=""/>
<updated/>
</sys_remote_update_set>
<sys_update_xml action="INSERT_OR_UPDATE">
<action>INSERT_OR_UPDATE</action>
<application display_value="GRC: Policy and Compliance Management">4a3281d053030200d23c9c25911c086f</application>
<category>customer</category>
<comments/>
<name>sys_script_include_4feeee6cdbd27010bb5a4a28139619b0</name>
<payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;&lt;sys_script_include action="INSERT_OR_UPDATE"&gt;&lt;access&gt;public&lt;/access&gt;&lt;active&gt;true&lt;/active&gt;&lt;api_name&gt;sn_compliance.PolicyPDFHelper&lt;/api_name&gt;&lt;caller_access/&gt;&lt;client_callable&gt;false&lt;/client_callable&gt;&lt;description/&gt;&lt;name&gt;PolicyPDFHelper&lt;/name&gt;&lt;script&gt;&lt;![CDATA[var PolicyPDFHelper = Class.create();
PolicyPDFHelper.prototype = {
    initialize: function () {
    },

    getPDFBase64: function (kbSysId, landscape) {
        var grKB = new GlideRecord('kb_knowledge'),
            gsattachment = new GlideSysAttachment(),
            body = '',
            text = '';

        grKB.get(kbSysId);
        text = grKB.getValue('text');

        var att = this.generatePDFAttachment(text, kbSysId, 'kb_knowledge', kbSysId, landscape);

        if (att) {
            var retval = this.getAttNameAndBase64(att, true);
			if (retval) {
				if (retval.base64) {
					return retval.base64;
				}
			}
        }
        return false;
    },

    generatePDFAttachment: function (html, fileName, tableName, recordSysId, landscape) {
        var body = '';
        /* 
        PDF exports don't seem to like '/sys_attachment' for images. 
        It works in the web interface, but will not export correctly.
        Here I remove the forward slashes which is causing the issue. 
        */
        if (html.indexOf('/sys_attachment.do?sys_id') &gt; -1) {
            html = html.replace(/\/sys_attachment/g, 'sys_attachment');
        }

        body = (landscape) ? '&lt;style&gt;@page {size: A4 landscape;}&lt;/style&gt;' + html : html;

        // Generate the PDF and attach it to the KB record. 
        var att = new sn_pdfgeneratorutils.PDFGenerationAPI().convertToPDF(body, tableName, recordSysId, fileName, '');
        if (att.attachment_id) {
            return att.attachment_id;
        }
        return false;
    },

    getAttNameAndBase64: function (attSysId, deleteRecord) {
        var grAttachment = new GlideRecord('sys_attachment'),
            gsattachment = new GlideSysAttachment();
        // Get the PDF we just attached. 
        if (grAttachment.get(attSysId)) {
            // Get the base64 of the content for the download. 
            var attachmentContent = gsattachment.getContentBase64(grAttachment),
                fileName = grAttachment.getValue('file_name');

            if (attachmentContent) {
                if (deleteRecord) {
                    // Now that we have the base64, let's delete the attachment record. 
                    grAttachment.deleteRecord();
                }
                return {
                    'file_name': fileName, 'base64': attachmentContent
                };
            }
        }
        return false;
    },

    type: 'PolicyPDFHelper'
};]]&gt;&lt;/script&gt;&lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;&lt;sys_created_by&gt;jhanson&lt;/sys_created_by&gt;&lt;sys_created_on&gt;2021-08-27 22:11:32&lt;/sys_created_on&gt;&lt;sys_customer_update&gt;false&lt;/sys_customer_update&gt;&lt;sys_id&gt;4feeee6cdbd27010bb5a4a28139619b0&lt;/sys_id&gt;&lt;sys_mod_count&gt;14&lt;/sys_mod_count&gt;&lt;sys_name&gt;PolicyPDFHelper&lt;/sys_name&gt;&lt;sys_package display_value="GRC: Policy and Compliance Management" source="sn_compliance"&gt;4a3281d053030200d23c9c25911c086f&lt;/sys_package&gt;&lt;sys_policy/&gt;&lt;sys_replace_on_upgrade&gt;false&lt;/sys_replace_on_upgrade&gt;&lt;sys_scope display_value="GRC: Policy and Compliance Management"&gt;4a3281d053030200d23c9c25911c086f&lt;/sys_scope&gt;&lt;sys_update_name&gt;sys_script_include_4feeee6cdbd27010bb5a4a28139619b0&lt;/sys_update_name&gt;&lt;sys_updated_by&gt;jhanson&lt;/sys_updated_by&gt;&lt;sys_updated_on&gt;2021-09-09 22:36:45&lt;/sys_updated_on&gt;&lt;/sys_script_include&gt;&lt;/record_update&gt;</payload>
<payload_hash>1363590806</payload_hash>
<remote_update_set display_value="ExportKBtoPDF-PDFHelper">5957ddf42f43b8101d84d2172799b614</remote_update_set>
<replace_on_upgrade>false</replace_on_upgrade>
<sys_created_by>admin</sys_created_by>
<sys_created_on>2021-10-04 16:57:17</sys_created_on>
<sys_id>5d57ddf42f43b8101d84d2172799b614</sys_id>
<sys_mod_count>0</sys_mod_count>
<sys_recorded_at>17c4be8da210000001</sys_recorded_at>
<sys_updated_by>admin</sys_updated_by>
<sys_updated_on>2021-10-04 16:57:17</sys_updated_on>
<table/>
<target_name>PolicyPDFHelper</target_name>
<type>Script Include</type>
<update_domain>global</update_domain>
<update_guid>9a45b5b01beebc94bda8aab251ca3ff3</update_guid>
<update_guid_history>9a45b5b01beebc94bda8aab251ca3ff3:1363590806,2f1579bc2eaebc94281120481c3b4a97:-856008993,6a9638f815a27894d577527bf8d35ce2:177570987,6ef72c7c99eef4942cd56b3561dda5f1:1203677319,8617203081aef4946cc1d6bb3ff506ea:301335797,5f85a8fca1aaf49422b44afa807f843e:256282604,6aa8e8a6ded6bc5025485f06c4790dc4:-569242485,3d98e0268fd6bc501ea91438dc560e82:-1150505287,5c4524622216bc506b8a3101f40a3fe7:-1281807833,ff93a0aa1152bc502296e4570662a743:-1622735417,36f2e8267052bc509f747934d341a607:-1499724782,5556bee8b6d6701013efd40fe83411f4:658987350,7026baa8e9d670105e3def5b674e97a1:46185659,57d5762871d670104b2f25c1b6da1152:-1796134562,8ed2fe24fc967010af9a0e5fe7320059:-536174126</update_guid_history>
<update_set display_value=""/>
<view/>
</sys_update_xml>
</unload>
